import { Injectable, OnDestroy } from '@angular/core';

import { FTWeb3Service } from '../FTServices/ft-web3';
import { FTObserver } from '../FTFramework/FT-Observer';
import { FTSession } from '../FTFramework/FT-Session';
import { FTHttpClient } from '../FTFramework/FT-HttpClient';

@Injectable()

export class FTTokenWatchService {

  private ERC20ABI = [{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"gotFree","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalOutstanding","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"getFreeToken","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"author","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"},{"name":"_extraData","type":"bytes"}],"name":"approveAndCall","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"admin","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"}],"name":"unapprove","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"}];
  private EtherABI = [{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x06fdde03"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0x095ea7b3"},{"constant":true,"inputs":[],"name":"exportEscrow","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x1258c621"},{"constant":true,"inputs":[],"name":"totalOutstanding","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x16078d04"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x18160ddd"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0x23b872dd"},{"constant":true,"inputs":[],"name":"change","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x2ee79ded"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x313ce567"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x70a08231"},{"constant":false,"inputs":[{"name":"_to","type":"address"}],"name":"transferAdmin","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0x75829def"},{"constant":false,"inputs":[{"name":"_cryptoAddressFrom","type":"address"},{"name":"_cryptoAddressTo","type":"address"},{"name":"_value","type":"uint256"},{"name":"_cryptoBlockNumber","type":"uint256"},{"name":"_fee","type":"uint256"}],"name":"moveCryptoOut","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0x7dbc265a"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x95d89b41"},{"constant":false,"inputs":[{"name":"_cryptoAddressTo","type":"address"},{"name":"_value","type":"uint256"},{"name":"_cryptoBlockNumber","type":"uint256"},{"name":"_fee","type":"uint256"}],"name":"moveCryptoOutFromChange","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0x9a0de5fe"},{"constant":true,"inputs":[],"name":"fees","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x9af1d35a"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"uint256"}],"name":"preventDuplicates","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function","signature":"0x9cd6fa9f"},{"constant":true,"inputs":[],"name":"totalEscrow","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function","signature":"0xa3d89844"},{"constant":false,"inputs":[{"name":"_cryptoAddressFrom","type":"address"},{"name":"_value","type":"uint256"},{"name":"_cryptoBlockNumber","type":"uint256"},{"name":"_fee","type":"uint256"}],"name":"moveCryptoToChange","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0xa4ed25b9"},{"constant":true,"inputs":[],"name":"author","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function","signature":"0xa6c3e6b9"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0xa9059cbb"},{"constant":false,"inputs":[{"name":"_cryptoAddress","type":"address"},{"name":"_fttAddress","type":"address"}],"name":"createCryptoAddress","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0xbc9ee237"},{"constant":false,"inputs":[{"name":"_cryptoAddress","type":"address"},{"name":"_value","type":"uint256"}],"name":"export","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0xc052f888"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"cryptoAddressReceiver","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function","signature":"0xc1375931"},{"constant":true,"inputs":[],"name":"coveredFees","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function","signature":"0xc8973556"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"},{"name":"_extraData","type":"bytes"}],"name":"approveAndCall","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0xcae9ca51"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function","signature":"0xdd62ed3e"},{"constant":false,"inputs":[{"name":"_feesToPay","type":"uint256"},{"name":"_cryptoAddressFrom","type":"address"},{"name":"_fee","type":"uint256"},{"name":"_cryptoBlockNumber","type":"uint256"}],"name":"payFees","outputs":[{"name":"succes_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0xebb29e91"},{"constant":true,"inputs":[],"name":"admin","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function","signature":"0xf851a440"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"cryptoAddressBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function","signature":"0xfa58bfb7"},{"constant":false,"inputs":[{"name":"_spender","type":"address"}],"name":"unapprove","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0xfbf1f78a"},{"constant":false,"inputs":[{"name":"_fromCryptoAddress","type":"address"},{"name":"_cryptoAddress","type":"address"},{"name":"_value","type":"uint256"},{"name":"_cryptoBlockNumber","type":"uint256"},{"name":"_fee","type":"uint256"}],"name":"receive","outputs":[{"name":"success_","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function","signature":"0xfe35319a"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor","signature":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event","signature":"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event","signature":"0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":true,"name":"blockNumber","type":"uint256"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"fee","type":"uint256"}],"name":"CryptoChange","type":"event","signature":"0xf814aa3f2a070fb35e9ec8d5b87a062784c4ec9a74ba22d6ba26a4eaddce7716"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":true,"name":"blockNumber","type":"uint256"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"fee","type":"uint256"}],"name":"CryptoExternalChange","type":"event","signature":"0x7a3d13eb64d202fdc227df6e366c6013c574615612d51fef0f343125045cc68d"},{"anonymous":false,"inputs":[{"indexed":true,"name":"cryptoAddress","type":"address"},{"indexed":true,"name":"sender","type":"address"},{"indexed":true,"name":"mNow","type":"uint256"},{"indexed":false,"name":"value","type":"uint256"}],"name":"SendToAddress","type":"event","signature":"0xeae2c16ea51acf1314b3799e81c82f6fd19d5006d14df45aca5b5db2df695a75"}];
  TokenWatch:any[] = [];
  myContracts:any[] = [];
  /*
  address, name, contract, abi, mine, mineTrade, subscribeBook, buyMap, sellMap, subscribeTrades, lastPrice, lastCount, tradeMap, myTradesMap
  */

  constructor ( private ftweb3: FTWeb3Service, private obs: FTObserver, private http: FTHttpClient, private session:FTSession ) { 
    //ToDo: Be better to look up name/ABI from AWS
    //ToDo: Should have token type (Main, Created, Watch)
    this.addTokenToWatch('0xdF5c7D102fAC895cB21bF0AaA55458562b018D92', 'Ethereum', this.EtherABI);
    this.addTokenToWatch('0x2d5e86187855CC29B40469e8a7355f3fDBf4C088', 'TradeToken', this.ERC20ABI);
    this.addTokenToWatch('0x9287bb21719d283CfdD7d644a89E8492f9845B64', 'FreeToken', this.ERC20ABI);



    this.obs.getObserver('isSignedIn').subscribe( (data) => {
      if(data == true) {
          let token = this.session.getItem('token');
          let account = this.session.getItem('account');
          if(token && account)
              this.http.put("publishContract", JSON.stringify({
                  "token" : token,
                  "address": account
                  })).toPromise()
              .then( data => {
                  if(data) {
                      try{
                          data = JSON.parse(data).sort(function(a, b){return a.ContractNameVer - b.ContractNameVer});
                          data.forEach(element => {
                              this.addTokenToWatch(element.PublishedAddress, element.ContractNameVer,JSON.parse(element.ContractABI));
                          });
                      }
                      catch {}
                      this.myContracts = data;
                  }
              })
              .catch( err => {console.log(err);});
      }
    });
  }

  ngOnDestroy(): void {
  }

  addTokenToWatch(address, name, ABI) {
    if(this.getTokenIndexByAddress(address==-1)) {
      let contract: any = this.ftweb3.createContractInterface(ABI, address.substring(2));
      let token:any = {address:address, name:name, contract:contract, abi:ABI, mine:'0', mineTrade:'0', buyMap:{}, sellMap:{}, tradeMap:{}, myTradesMap:{}, lastPrice:'0', lastCount:'0' };
      this.TokenWatch.push(token);
    }
  }

  getTokenIndexByAddress(address) {
    return this.TokenWatch.findIndex(x => x.address === address);
  }

}
